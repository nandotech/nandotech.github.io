<!DOCTYPE html>
<html lang="en">
<head>
  
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Building an (awesome) API with NancyFX 2.0 &#43; Dapper</title>

  <meta name="author" content="Fernando Rodriguez" />
  
  
  <meta name="description" content="Blog posts on programming, technology and entrepreneurship. A true polyglot, Software Developer and CEO of NandoTech Inc, Fernando Rodriguez, blogging on how &amp; where we cater custom software &amp; SIP solutions for small to medium sized businesses.">
  
  <meta name="keywords" content="blog, company, nandotech, software engineer, web development, microsoft, consultant">

  <meta name="generator" content="Hugo 0.16" />

  <link rel="alternate" href="https://nandotech.github.io/index.xml" type="application/rss+xml" title="NandoTech">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://nandotech.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://nandotech.github.io/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://nandotech.github.io/css/pygment_highlights.css" />
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  <meta property="og:title" content="Building an (awesome) API with NancyFX 2.0 &#43; Dapper" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/" />
  <meta property="og:image" content="img/nandotech_logo_gray.gif" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://nandotech.github.io/">NandoTech</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">           
      
        
          <li>
          <a title="Company Website" href="http://nandotech.com">Company Website</a>
  	      </li>
  	    
      
        
          <li>
          <a title="Blog" href="https://nandotech.github.io/">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="https://nandotech.github.io/page/about/">About</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="NandoTech" href="https://nandotech.github.io/">
              <img class="avatar-img" src="https://nandotech.github.io/img/nandotech_logo_gray.gif" alt="NandoTech" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      
        




  <div id="header-big-imgs" data-num-img=1 data-img-src-1="/img/nancyhome.png"></div>


<header class="header-section has-img">

<div class="big-img intro-header">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Building an (awesome) API with NancyFX 2.0 &#43; Dapper</h1>
      
        
      <h2 class="post-subheading">Plus, dependency injection explained and everything you need to get up and running.</h2>
      
      
      
      
      <span class="post-meta">Posted on October 21, 2016</span>
      
        </div>
      </div>
    </div>
  </div>
  <span class='img-desc'></span>
</div>

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Building an (awesome) API with NancyFX 2.0 &#43; Dapper</h1>
      
        
      <h2 class="post-subheading">Plus, dependency injection explained and everything you need to get up and running.</h2>
      
      
      
      
      <span class="post-meta">Posted on October 21, 2016</span>
      
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<h2 id="nancyfx-dapper-are-so-hot-right-now-naturally-i-had-to-put-them-together">NancyFX &amp; Dapper are so hot right now. Naturally, I had to put them together.</h2>

<h4 id="i-am-a-huge-fan-and-follower-of-net-core-https-dot-net-and-the-entire-open-source-movement-insinde-microsoft">I am a huge fan and follower of <a href="https://dot.net">.NET Core</a> and the entire open source movement insinde Microsoft.</h4>

<p><a href="http://asp.net">ASP.NET Core</a> looks extremely promising, but I was always a fan of NancyFX and wanted to try it out. Subsequently, I was extremely excited when I found out that <a href="http://nancyfx.org">NancyFX</a> would be compatible with Core, and I basically gave myself a reason to use it.</p>

<p>That reason is a rather small Web API project that I very simply needed to accept <code>POST</code> requests from two separate web servers/services and provide <code>GET</code> routes that would be accessed via a SPA (probably <a href="http://angular.io">Angular 2</a>) with some relevant business information that would be coming in from the API&rsquo;s.</p>

<p>Moral of the story is that this was incredibly easy to accomplish, especially if you stay on the &ldquo;<a href="https://github.com/NancyFx/Nancy/wiki/Introduction">Super Duper Happy Path</a>&rdquo; as the developers like to put it.  We will only cover the back end service here, possibly saving the Angular 2 portion for another post.</p>

<p>With Core, we have a few options as it pertains to tooling, it really comes down to personal preference.  You may generate and do everything necessary from the <a href="https://github.com/dotnet/cli">command line</a> and utilize your text editor of choice (in this case, I prefer <a href="http://code.visualstudio.com/">VS Code</a>).  My personal preference is actually still to use the full version of Visual Studio for the C#/.NET coding, though I do like some of the cli templates better.</p>

<p>Generally, I like to take some parts of ASP.NET web templates to help take care of some boilerplate, but there is some value in doing everything from scratch. Below, we&rsquo;ll explore a few options.</p>

<p>So, why not both?</p>

<table>
<thead>
<tr>
<th><strong>CLI/Code</strong></th>
<th><strong>Visual Studio</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td><img src="http://i.imgur.com/PhJP72m.png" alt=".NET Core CLI" /></td>
<td><img src="http://i.imgur.com/HoGGd07.png" alt="VS Web API" /></td>
</tr>

<tr>
<td><img src="http://i.imgur.com/VVHHhQG.png" alt="VS Code" /></td>
<td><img src="http://i.imgur.com/69T7KsR.png" alt="Bare WebAPI Proj" /></td>
</tr>
</tbody>
</table>

<p>From here, the direction are basicallly identical regardless which IDE or setup you are attempting to use. I will try to point out differences wherever possible. Also of note, from the <code>dotnet</code> cli you may use the command <code>dotnet new -t web</code> to get a full ASP.NET application.  Alternatively, you can also use the <a href="http://yeoman.io/">Yeoman</a> tool that provides several different templates that can be utilized typing <code>yo aspnet</code> (<a href="https://docs.asp.net/en/latest/client-side/yeoman.html">assuming you&rsquo;ve installed yeoman &amp; the aspnet generators</a>).</p>

<p>Regardless which route you go, next step here is our config files.  Every Core project has a <code>project.json</code> and we will also add an <code>appsettings.json</code> file where we will inject some static data from as well as database connection string.</p>

<p><em>project.json</em></p>

<pre><code class="language-json">{
  &quot;dependencies&quot;: {
    &quot;Microsoft.NETCore.App&quot;: {
      &quot;version&quot;: &quot;1.0.1&quot;,
      &quot;type&quot;: &quot;platform&quot;
    },
    &quot;Microsoft.AspNetCore.Diagnostics&quot;: &quot;1.0.0&quot;,
    &quot;Microsoft.AspNetCore.Server.IISIntegration&quot;: &quot;1.0.0&quot;,
    &quot;Microsoft.AspNetCore.Server.Kestrel&quot;: &quot;1.0.1&quot;,
    &quot;Microsoft.Extensions.Logging.Console&quot;: &quot;1.0.0&quot;,
    &quot;Microsoft.AspNetCore.Owin&quot;: &quot;1.0.0&quot;,
    &quot;Nancy&quot;: &quot;2.0.0-barneyrubble&quot;,
    &quot;Dapper&quot;: &quot;1.50.2&quot;,
    &quot;Microsoft.Extensions.Configuration.FileExtensions&quot;: &quot;1.0.0&quot;,
    &quot;Microsoft.Extensions.Configuration.Json&quot;: &quot;1.0.0&quot;
  },
  &quot;tools&quot;: {
    &quot;Microsoft.AspNetCore.Server.IISIntegration.Tools&quot;: &quot;1.0.0-preview2-final&quot;
  },
  &quot;frameworks&quot;: {
    &quot;netcoreapp1.0&quot;: {}
  },
  &quot;buildOptions&quot;: {
    &quot;debugType&quot;: &quot;portable&quot;, 
    &quot;emitEntryPoint&quot;: true
  },
  &quot;runtimeOptions&quot;: {
    &quot;configProperties&quot;: {
      &quot;System.GC.Server&quot;: true
    }
  },
  &quot;publishOptions&quot;: {
    &quot;include&quot;: [
      &quot;wwwroot&quot;,
      &quot;web.config&quot;
    ]
  },
  &quot;scripts&quot;: {
    &quot;postpublish&quot;: [ &quot;dotnet publish-iis --publish-folder %publish:OutputPath% --framework %publish:coreclr%&quot; ]
  }
}
</code></pre>

<p><em>appsettings.json</em></p>

<pre><code class="language-json">{
  &quot;ConnectionStrings&quot;: {
    &quot;DefaultConnection&quot;: &quot;Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog=DemoDb;Integrated Security=True;Connect Timeout=30;Encrypt=False;TrustServerCertificate=True;ApplicationIntent=ReadWrite;MultiSubnetFailover=False&quot;
  },
    &quot;Greeting&quot;: &quot;A configurable Hello!&quot;
}
</code></pre>

<p>Here, we&rsquo;ll use <code>DefaultConnection</code> as our DB connection string and will be injecting <code>Greeting</code> via Dependency Injection as a simple API string response and in a Nancy view, mainly just to show that we can do that. :)</p>

<p>Depending which app template you used, you may or may not already have a <code>Startup.cs</code> file in the root of your project. Either way, we want to edit that file to look like so:</p>

<p><em>Startup.cs</em></p>

<pre><code class="language-csharp">    public class Startup
    {
        // This method gets called by the runtime. Use this method to add services to the container.
        public void ConfigureServices(IServiceCollection services)
        {
            // All dependency injection will be done in NancyBootstrapper
        }
        // This method gets called by the runtime.
        // We will configure this to use Nancy middleware.
        public void Configure(IApplicationBuilder app,
                              IHostingEnvironment env,
                              ILoggerFactory loggerFactory)
        {
            //Not required, but we will use later on
            loggerFactory.AddConsole();
            // Creating our request pipeline--strictly Nancy middleware
            app.UseOwin(x =&gt; x.UseNancy());
        }
    }
</code></pre>

<p>At this point, if we define a <code>HomeModule</code> which is Nancy&rsquo;s default route, equivalent to the <code>HomeController</code> in MVC, then you will have an API that can handle requests already. While I like to split up these different types of code files into folders, it is not in any way required.</p>

<p>Below is a very basic module with a &ldquo;Hello World&rdquo; message at the <code>/</code> route at <code>localhost:5000</code>. You can also see Nancy returning your current OS (or whatever is hosting the app) by visiting <code>localhost:5000/os</code>.  Below code also demonstrates how you may write your route definitions in-line (for very short routes) and also within blocks (curly braces) allowing you to write as much code as you need.</p>

<p><em>HomeModule.cs</em></p>

<pre><code class="language-csharp"> public class HomeModule : NancyModule
    {
        public HomeModule()
        {
            Get(&quot;/&quot;, args =&gt; &quot;Hello World&quot;);

            Get(&quot;/os&quot;, x =&gt;
            {
                return System.Runtime.InteropServices.RuntimeInformation.OSDescription;
            });
        }
    }
</code></pre>

<p>We will experiment with injecting dependencies using Nancy&rsquo;s built in <code>TinyIoC</code> and also build a few other modules. We&rsquo;ll include very cursory, somewhat contrived examples, but you will get to also see how <code>async</code> modules look along with the use of <code>Before</code> and <code>After</code> request pipelines in Nancy modules. The same applies for Nancy views, though I will try and provide some explanation and/or guidance with links to point you in the right direction.</p>

<p><em>&hellip;To be completed</em></p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://nandotech.github.io/post/2016-10-20-happy-halloween/" data-toggle="tooltip" data-placement="top" title="Happy Halloween!">&larr; Previous Post</a>
        </li>
        
        
      </ul>

      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          <li>
            <a href="https://www.facebook.com/nandotechinc" title="Facebook">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/nandotech" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://twitter.com/nandotechinc" title="Twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="mailto:info@nandotech.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://linkedin.com/in/fernando-rodriguez-6082914a" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
	    	  
          <li>
            <a href="https://stackoverflow.com/users/4308952/fernando-rodriguez" title="StackOverflow">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          

    		  <li>
      			<a href="https://nandotech.github.io/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="copyright text-muted">
          &copy; 
    		  2016
    		  
    		  <a href="https://nandotech.github.io/">NandoTech, Inc.</a>
    		  
    		  &nbsp;&bull;&nbsp;
    		  Fernando Rodriguez
    		  
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme by
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://nandotech.github.io/js/jquery-1.11.2.min.js"></script>
<script src="https://nandotech.github.io/js/bootstrap.min.js"></script>
<script src="https://nandotech.github.io/js/main.js"></script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-59045667-5', 'auto');
ga('send', 'pageview');
</script>


  </body>
</html>
